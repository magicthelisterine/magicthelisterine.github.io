const SubmitForm={data:null,name:null,serie:null,supertype:null,type:null,dnd:null,desc:null,submitbtn:null,loadingModal:null,emailModal:null,init:function(e){this.data=e,this.dnd=document.getElementById("dnd"),this.name=document.getElementById("name"),this.serie=document.getElementById("serie"),this.supertype=document.getElementById("supertype"),this.type=document.getElementById("type"),this.desc=document.getElementById("desc"),this.submitbtn=document.getElementById("submit-btn"),this.fillSerie(e.series),this.fillSuperType(e.supertypes),this.fillType(e.types),DropImage.init(this.dnd),HintSymbols.init(),MTGEditor.init(this.desc),this.loadingModal=new LoadingModal,this.emailModal=new EmailModal,bind(".card-submit-container form","submit",(e=>{e.preventDefault(),this.submit()}))},fillSerie:function(e){e.forEach((e=>{const t=create("option");t.innerText=e,t.value=e,this.serie.append(t)}))},fillSuperType:function(e){e.forEach((e=>{const t=create("option");t.innerText=e,t.value=e,this.supertype.append(t)}))},fillType:function(e){e.forEach((e=>{const t=create("option");t.innerText=e,t.value=e,this.type.append(t)}))},progress:function(e){this.submitbtn.disabled=e<1},submit:function(){if(!DropImage.value)return DropImage.div.classList.add("dragover"),void scrollTo(DropImage.div);this.emailModal.show(((e,t)=>{const i={author:e,email:t,name:document.getElementById("name").value,serie:document.getElementById("serie").value,supertype:document.getElementById("supertype").value,type:document.getElementById("type").value,subtype:document.getElementById("subtype").value,power:document.getElementById("power").value,toughness:document.getElementById("toughness").value,cost:document.getElementById("costInput").value,description:document.getElementById("desc").value,flavor:document.getElementById("flavor").value,image:{filename:DropImage.value.name,image:DropImage.value.contents}};this.loadingModal.show(),Brainstorm.addCard(i).then((e=>{this.loadingModal.hide(),e.success?MessageModal.thumbsup("Bravo! Votre carte vient d’être envoyée dans le Plan Astral du comité éditorial. Si elle survit au sort de Contrebullshit, elle sera publiée bientôt.",(()=>{document.location.href="../"})):MessageModal.alert(`Une erreur s'est produite.<br>${e.errmsg}`)}))}))}};window.SubmitForm=SubmitForm;const HintSymbols={symbols:["U","G","B","W","R","0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","2B","2G","2R","2U","2W","BG","BR","GU","GW","RG","RW","UB","UR","WB","WU","X","Y","Z","C"],hintBox:null,input:null,cost:null,init:function(){this.hintBox=document.body.create("div","card-submit-cost-symbols"),this.input=document.getElementById("costInput"),this.cost=document.getElementById("costRender"),this.symbols.forEach((e=>{this.hintBox.create("div","symbol-24px icon-"+e).bind("click",(t=>{this.input.value+="{"+e+"}",this.renderCost()}))})),this.input.bind("input",(e=>{this.renderCost()}));let e=!1;this.input.addEventListener("focus",(()=>{this.hintBox.style.display="block",this.hintBox.style.visibility="hidden";const e=this.input.getBoundingClientRect(),t=this.hintBox.offsetHeight;this.hintBox.style.left=e.left+window.scrollX+"px",this.hintBox.style.top=e.top+window.scrollY-t-8+"px",this.hintBox.style.visibility="visible"})),this.input.addEventListener("blur",(()=>{e||(this.hintBox.style.display="none")})),this.hintBox.addEventListener("mousedown",(()=>{e=!0})),this.hintBox.addEventListener("mouseup",(()=>{setTimeout((()=>{e=!1,this.input.focus()}),0)}))},renderCost:function(){let e="";[...this.input.value.matchAll(/\{(.*?)\}/g)].map((e=>e[1])).forEach((t=>{e+=`<div class="symbol-24px icon-${t}"></div>`})),this.cost.innerHTML=e}},DropImage={div:null,value:null,init:function(e){this.div=e,this.div.addEventListener("dragover",(e=>{e.preventDefault(),this.div.classList.add("dragover")})),this.div.addEventListener("dragleave",(()=>{this.div.classList.remove("dragover")})),this.div.addEventListener("drop",(e=>{e.preventDefault(),this.div.classList.remove("dragover");const t=e.dataTransfer.files;t.length>0&&this.handleFile(t[0])})),this.div.addEventListener("click",(e=>{browse("image/*",(e=>{e.target.files.length>0&&this.handleFile(e.target.files[0])})),this.div.classList.remove("dragover")}))},handleFile:function(e){if(e.type.startsWith("image/")&&e.size<=5242880){const t=new FileReader;t.onload=t=>{this.value={name:e.name,size:e.size,type:e.type,contents:t.target.result},this.div.style.setProperty("--bg-image",`url("${t.target.result}")`)},t.readAsDataURL(e)}}},MTGEditor={symbols:["I","U","G","B","W","R","0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","2B","2G","2R","2U","2W","BG","BR","GU","GW","RG","RW","UB","UR","WB","WU","X","Y","Z","T","T1","T2"],toolbar:null,elm:null,init:function(e){this.elm=e,this.toolbar=create("div","MTGEditor-toolbar"),this.elm.parentElement.insertBefore(this.toolbar,this.elm),this.symbols.forEach((e=>{this.toolbar.create("div","symbol-24px icon-"+e).bind("click",(t=>{"I"==e?this.wrapItalic():this.insert("{"+e+"}")}))}))},insert:function(e){const t=this.elm.selectionStart,i=this.elm.selectionEnd,s=this.elm.value.substring(0,t),l=this.elm.value.substring(i);this.elm.value=s+e+l;const n=t+e.length;this.elm.selectionStart=this.elm.selectionEnd=n,this.elm.focus()},wrapItalic:function(){const e=this.elm.selectionStart,t=this.elm.selectionEnd,i=this.elm.value.substring(e,t);let s,l;i.length>0?(s=`{I}${i}{/I}`,l=e+s.length):(s="{I}{/I}",l=e+3);const n=this.elm.value.slice(0,e),o=this.elm.value.slice(t);this.elm.value=n+s+o,this.elm.selectionStart=this.elm.selectionEnd=l,this.elm.focus()}};class EmailModal extends Modal{form=null;clb=null;constructor(){let e=create("form","email-modal");e.innerHTML='<table><thead><tr><th colspan="2">Auteur</th></tr></thead><tbody><tr><td colspan="2"><input type="text" name="name" autocomplete="off" placeholder="Nom" required></td></tr><tr><td colspan="2"><input type="email" name="email" autocomplete="off" placeholder="Courriel" required></td></tr></tbody><tfoot><tr><td class="cell-half-width"><input type="submit" name="save" value="Confirmer"></td><td class="cell-half-width"><input type="button" name="cancel" value="Annuler"></td></tr></tfoot></table>',super(e),this.form=e,bind(this.form,"submit",(e=>{e.preventDefault(),this.save()})),this.form.querySelector('input[name="cancel"]').addEventListener("click",(e=>{this.cancel()}))}show(e=null){this.clb=e,this.form.querySelector('input[name="name"]').value=localStorage.getItem("submit-author_name"),this.form.querySelector('input[name="email"]').value=localStorage.getItem("submit-author_email"),super.show(),setTimeout((()=>{this.form.querySelector('input[name="name"]').focus()}),200)}save(){const e=this.form.querySelector('input[name="name"]').value,t=this.form.querySelector('input[name="email"]').value;localStorage.setItem("submit-author_name",e),localStorage.setItem("submit-author_email",t),this.hide(),this.clb&&this.clb(e,t)}cancel(){this.hide()}}class LoadingModal extends Modal{loading=null;constructor(){let e=create("div","loading-tri-circular center");super(e),this.loading=e}show(){this.loading.style.setProperty("--state","running"),super.show()}hide(){super.hide(),this.loading.style.setProperty("--state","paused")}}