const thumbnail_path=root+"assets/images/cartes/thumbnails/",WHITE=1,RED=2,BLUE=4,GREEN=8,BLACK=16,CardPool={data:null,main:null,modal:null,toolbar:null,cards:[],filters:{sortby:"added_desc",type:"",exclusive:!1,colorless:!1,blue:!1,green:!1,red:!1,black:!1,white:!1},init:async function(e){this.data=e,this.modal=new CardModal,this.main=query("main"),this.getCards().then((e=>{this.cards=e,this.setFilters(),this.container=create("article"),this.toolbar=this.renderToolbar(),this.container.append(this.renderCards(this.cards)),this.main.replaceChildren(this.toolbar,this.container)})).catch((e=>{MessageModal.alert(e,(()=>{document.location.href=root}))}))},getCards:async function(){try{const e=await Brainstorm.getCards();if(e.success)return e.rows.forEach((e=>{let t=e.type;e.supertype&&(t=e.supertype+" "+t),e.subtype&&(t=t+" - "+e.subtype);let s=this.renderTextSymbols(e.description);e.flavor&&(s+=`<hr><i>${e.flavor}</i>`);let r=null,i=null,a=null;e.image&&(e.image.webp_small&&(r=thumbnail_path+e.image.webp_small),e.image.webp_medium&&(i=thumbnail_path+e.image.webp_medium),e.image.webp_large&&(a=thumbnail_path+e.image.webp_large));let c=null;["Creature","Artifact Creature"].includes(e.type)&&(c=e.power+"/"+e.toughness);let o=this.trimBraces(e.cost),l=0,n={blue:!1,red:!1,green:!1,white:!1,black:!1,colorless:!1};[...o.matchAll(/\{(.*?)\}/g)].map((e=>e[1])).forEach((e=>{e=e.toUpperCase(),l+=isNaN(e)?1:parseInt(e),isNaN(e)?(e.includes("R")&&(n.red=!0),e.includes("G")&&(n.green=!0),e.includes("U")&&(n.blue=!0),e.includes("W")&&(n.white=!0),e.includes("B")&&(n.black=!0)):n.colorless=!0}));let d=0;n.red&&(d+=2),n.blue&&(d+=4),n.green&&(d+=8),n.white&&(d+=1),n.black&&(d+=16),e.computed={name:e.name,legend:t,thumb_small:r,thumb_medium:i,thumb_large:a,cost:o,cost_real:l,cost_render:this.renderSymbols(o),power_toughness:c,description:s,colorsum:d,colors:n}})),e.rows;throw e.errmsg}catch(e){return Promise.reject(e)}},setFilters:function(e={}){this.filters={...this.filters,...e};const[t,s]=this.filters.sortby.split("_");switch(t){case"added":this.cards.sort(((e,t)=>new Date(e.createdAt)-new Date(t.createdAt)));break;case"modified":this.cards.sort(((e,t)=>new Date(e.lastModifiedAt)-new Date(t.lastModifiedAt)));break;case"name":this.cards.sort(((e,t)=>e.name.localeCompare(t.name)));break;case"cost":this.cards.sort(((e,t)=>e.computed.cost_real===t.computed.cost_real?e.name.localeCompare(t.name):e.computed.cost_real-t.computed.cost_real));break;case"power":this.cards.sort(((e,t)=>e.power===t.power?e.name.localeCompare(t.name):e.power-t.power));break;case"toughness":this.cards.sort(((e,t)=>e.toughness===t.toughness?e.name.localeCompare(t.name):e.toughness-t.toughness))}"desc"==s&&this.cards.reverse(),this.filters.exclusive?(this.filters.exclusive_sum=0,this.filters.red&&(this.filters.exclusive_sum+=2),this.filters.green&&(this.filters.exclusive_sum+=8),this.filters.blue&&(this.filters.exclusive_sum+=4),this.filters.white&&(this.filters.exclusive_sum+=1),this.filters.black&&(this.filters.exclusive_sum+=16)):(this.filters.inclusive_sum=0,this.filters.red&&(this.filters.inclusive_sum|=2),this.filters.green&&(this.filters.inclusive_sum|=8),this.filters.blue&&(this.filters.inclusive_sum|=4),this.filters.white&&(this.filters.inclusive_sum|=1),this.filters.black&&(this.filters.inclusive_sum|=16)),this.cards.forEach((e=>e.display=this.isCardDisplay(e)))},isCardDisplay:function(e){if(this.filters.type&&this.filters.type!=e.type.toLowerCase())return!1;if(this.filters.colorless)return!e.computed.colorsum;if(this.filters.exclusive){if(this.filters.exclusive_sum&&e.computed.colorsum!=this.filters.exclusive_sum)return!1}else if(this.filters.inclusive_sum&&!(e.computed.colorsum&this.filters.inclusive_sum))return!1;return!0},renderToolbar:function(){const e=create("div","card-toolbar"),t=e.create("div","card-toolbar__column"),s=t.create("select");this.data.sortby.forEach(((e,t)=>{const r=e.name+"_"+e.order;s.create("option","",e.title).value=r,this.filters.sortby==r&&(s.selectedIndex=t)})),s.addEventListener("change",(e=>{this.sortBy(s.value)}));const r=t.create("select");r.create("option","","Tous les types").value="",this.data.types.forEach((e=>{r.create("option","",e.title).value=e.name})),r.addEventListener("change",(e=>{this.sortType(r.value)}));const i=e.create("div","card-toolbar__column");return["white","red","blue","green","black","colorless","exclusive"].forEach((e=>{const t=i.create("input","checkbox-"+e);t.type="checkbox",t.addEventListener("change",(s=>{"colorless"==e&&i.querySelectorAll("input:not(.checkbox-colorless)").forEach((e=>{e.disabled=t.checked})),this.setFilters({[e]:t.checked}),this.updateCardList()}))})),e},renderCards:function(e){const t=create("div","card-grid");return e.forEach((e=>{e.display&&t.append(this.renderCard(e))})),t},renderCard:function(e){const t=create("div","card-grid__item"),s=t.create("div","card-grid__item__icon");e.computed.thumb_small&&(s.style.backgroundImage="url("+e.computed.thumb_small+")");const r=t.create("div","card-grid__item__details");r.create("div","card-grid__item__details__name",e.computed.name);const i=r.create("div","card-grid__item__details__description");return i.create("div","card-grid__item__details__description__legend",e.computed.legend),i.create("div","card-grid__item__details__description__power_toughness",e.computed.power_toughness),i.create("div","card-grid__item__details__description__cost",e.computed.cost_render),t.dataset.uuid=e.uuid,t.addEventListener("click",(t=>{this.modal.show(e.computed)})),t},updateCardList:function(){this.container.replaceChildren(this.renderCards(this.cards))},sortBy:function(e){this.setFilters({sortby:e}),this.updateCardList()},sortType:function(e){this.setFilters({type:e}),this.updateCardList()},renderSymbols:function(e){let t="";return[...String(e).matchAll(/\{(.*?)\}/g)].map((e=>e[1])).forEach((e=>{t+=`<div class="symbol-1em icon-${e}"></div>`})),t},renderTextSymbols:function(e){return String(e).replace(/\n/g,'<span class="line-break"></span>').replace(/\{i\}(.*?)\{\/i\}/gi,"<em>$1</em>").replace(/\{(?!\/?i\})(.*?)\}/gi,((e,t)=>`<div class="symbol-1em icon-${t.toUpperCase()}"></div>`))},trimBraces:function(e){return(String(e).match(/{[^}]*}/g)||[]).join("")}};class CardModal extends Modal{constructor(){super(),this.cont.addEventListener("mousedown",(e=>{this.hide()})),document.addEventListener("keydown",(e=>{this.opened&&"Escape"===e.key&&!(e.ctrlKey||e.altKey||e.shiftKey)&&this.hide()}))}show(e){const t=create("div","cardinfo"),s=t.create("div","cardinfo__thumb");e.thumb_medium&&(s.style.backgroundImage="url("+e.thumb_medium+")"),t.create("div","cardinfo__name",e.name),t.create("div","cardinfo__legend",e.legend),t.create("div","cardinfo__cost","<strong>Co√ªt:</strong> "+e.cost_render),t.create("div","cardinfo__power_toughness","<strong>Force/Endurance:</strong> "+(e.power_toughness?e.power_toughness:"")),t.create("div","cardinfo__description",e.description),super.show(t)}cancel(){this.hide()}}