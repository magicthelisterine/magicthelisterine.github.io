const thumbnail_path=root+"assets/images/cartes/thumbnails/",WHITE=1,RED=2,BLUE=4,GREEN=8,BLACK=16,CardPool={data:null,main:null,modal:null,toolbar:null,cards:[],filters:{sortby:"added_desc",type:"",colorless:!1,blue:!1,green:!1,red:!1,black:!1,white:!1},init:async function(r){this.data=r,this.modal=new CardModal,this.main=query("main"),this.getCards().then(e=>{this.cards=e,this.container=create("article"),this.toolbar=this.renderToolbar(),this.main.replaceChildren(this.toolbar,this.container),this.updateCardList()}).catch(e=>{MessageModal.alert(e,()=>{document.location.href=root})})},getCards:async function(){try{const r=await Brainstorm.getCards();if(r.success)return r.rows.forEach(e=>{e.type=e.type.trim(),e.supertype=e.supertype.trim(),e.subtype=e.subtype.trim();let s=e.type;e.supertype&&(s=e.supertype+" "+s),e.subtype&&(s=s+" - "+e.subtype);let t=this.renderTextSymbols(e.description);e.flavor&&(t+=`<hr><i>${e.flavor}</i>`);let a=e.type.includes("Creature")?`${e.power}/${e.toughness}`:"",c=this.trimBraces(e.cost),l=0,o={blue:0,red:0,green:0,white:0,black:0,colorless:!1};[...c.matchAll(/\{(.*?)}/g)].map(i=>i[1]).forEach(i=>{i=i.toUpperCase(),isNaN(i)?(l+=1,i.includes("R")&&(o.red=RED),i.includes("G")&&(o.green=GREEN),i.includes("U")&&(o.blue=BLUE),i.includes("W")&&(o.white=WHITE),i.includes("B")&&(o.black=BLACK)):(l+=parseInt(i),o.colorless=!0)});const n=Object.entries(o).reduce((i,[u,m])=>u==="colorless"?i:i|m,0);e.computed={name:e.name,legend:s,thumb_small:e.image?.webp_small?thumbnail_path+e.image.webp_small:null,thumb_medium:e.image?.webp_medium?thumbnail_path+e.image.webp_medium:null,thumb_large:e.image?.webp_large?thumbnail_path+e.image.webp_large:null,cost:c,cost_real:l,cost_render:this.renderSymbols(c),power_toughness:a,description:t,colorsum:n,colors:o}}),r.rows;throw r.errmsg}catch(r){return Promise.reject(r)}},setFilters:function(r={}){this.filters={...this.filters,...r};const[e,s]=this.filters.sortby.split("_");switch(e){case"added":this.cards.sort((t,a)=>new Date(t.createdAt)-new Date(a.createdAt));break;case"modified":this.cards.sort((t,a)=>new Date(t.lastModifiedAt)-new Date(a.lastModifiedAt));break;case"name":this.cards.sort((t,a)=>t.name.localeCompare(a.name));break;case"cost":this.cards.sort((t,a)=>t.computed.cost_real===a.computed.cost_real?t.name.localeCompare(a.name):t.computed.cost_real-a.computed.cost_real);break;case"power":this.cards.sort((t,a)=>t.power===a.power?t.name.localeCompare(a.name):t.power-a.power);break;case"toughness":this.cards.sort((t,a)=>t.toughness===a.toughness?t.name.localeCompare(a.name):t.toughness-a.toughness);break}s=="desc"&&this.cards.reverse(),this.filters.inclusive_sum=Object.entries({red:RED,green:GREEN,blue:BLUE,white:WHITE,black:BLACK}).reduce((t,[a,c])=>this.filters[a]?t|c:t,0),this.cards.forEach(t=>t.display=this.isCardDisplay(t))},isCardDisplay:function(r){return this.filters.type&&this.filters.type!=r.type.toLowerCase()?!1:this.filters.colorless?!r.computed.colorsum:this.filters.inclusive_sum?!r.computed.colorsum&&this.filters.inclusive_sum?!1:(r.computed.colorsum&this.filters.inclusive_sum)===r.computed.colorsum:!0},renderToolbar:function(){const r=create("div","card-toolbar"),e=r.create("div","card-toolbar__column"),s=e.create("select");this.data.sortby.forEach((c,l)=>{const o=c.name+"_"+c.order;s.create("option","",c.title).value=o,this.filters.sortby==o&&(s.selectedIndex=l)}),s.addEventListener("change",c=>{this.updateCardList({sortby:s.value})});const t=e.create("select");t.create("option","","Tous les types").value="",this.data.types.forEach(c=>{t.create("option","",c.title).value=c.name}),t.addEventListener("change",c=>{this.updateCardList({type:t.value})});const a=r.create("div","card-toolbar__column");return["white","red","blue","green","black","colorless"].forEach(c=>{const l=a.create("input","checkbox-"+c);l.type="checkbox",l.addEventListener("change",o=>{c=="colorless"&&a.querySelectorAll("input:not(.checkbox-colorless)").forEach(d=>{d.disabled=l.checked}),this.updateCardList({[c]:l.checked})})}),r},renderCards:function(r){const e=create("div","card-grid");return r.forEach(s=>{s.display&&e.append(this.renderCard(s))}),e},renderCard:function(r){const e=create("div","card-grid__item"),s=e.create("div","card-grid__item__icon");r.computed.thumb_small&&(s.style.backgroundImage="url("+r.computed.thumb_small+")");const t=e.create("div","card-grid__item__details");t.create("div","card-grid__item__details__name",r.computed.name);const a=t.create("div","card-grid__item__details__description");return a.create("div","card-grid__item__details__description__legend",r.computed.legend),a.create("div","card-grid__item__details__description__power_toughness",r.computed.power_toughness),a.create("div","card-grid__item__details__description__cost",r.computed.cost_render),e.addEventListener("click",c=>{this.modal.show(r.computed)}),e},updateCardList:async function(r={}){this.setFilters(r),this.container.replaceChildren(this.renderCards(this.cards))},renderSymbols:function(r){let e="";return[...String(r).matchAll(/\{(.*?)\}/g)].map(t=>t[1]).forEach(t=>{e+=`<div class="symbol-1em icon-${t.toUpperCase()}"></div>`}),e},renderTextSymbols:function(r){return String(r).replace(/\n/g,'<span class="line-break"></span>').replace(/\{i\}(.*?)\{\/i\}/gi,"<em>$1</em>").replace(/\{(?!\/?i\})(.*?)\}/gi,(e,s)=>`<div class="symbol-1em icon-${s.toUpperCase()}"></div>`)},trimBraces:function(r){return(String(r).match(/{[^}]*}/g)||[]).join("").toUpperCase()}};class CardModal extends Modal{constructor(){super(),this.cont.addEventListener("mousedown",e=>this.hide()),document.addEventListener("keydown",e=>{this.opened&&e.key==="Escape"&&!(e.ctrlKey||e.altKey||e.shiftKey)&&this.hide()})}show(e){const s=create("div","cardinfo"),t=s.create("div","cardinfo__thumb");e.thumb_medium&&(t.style.backgroundImage="url("+e.thumb_medium+")"),s.create("div","cardinfo__name",e.name),s.create("div","cardinfo__legend",e.legend),s.create("div","cardinfo__cost","<strong>Co\xFBt:</strong> "+e.cost_render),s.create("div","cardinfo__power_toughness","<strong>Force/Endurance:</strong> "+e.power_toughness),s.create("div","cardinfo__description",e.description),super.show(s)}}
