const thumbnail_path=root+"assets/images/cartes/thumbnails/",WHITE=1,RED=2,BLUE=4,GREEN=8,BLACK=16,CardPool={data:null,main:null,modal:null,toolbar:null,cards:[],filters:{sortby:"added_desc",type:"",colorless:!1,blue:!1,green:!1,red:!1,black:!1,white:!1},init:async function(e){this.data=e,this.modal=new CardModal,this.main=query("main"),this.getCards().then((e=>{this.cards=e,this.container=create("article"),this.toolbar=this.renderToolbar(),this.main.replaceChildren(this.toolbar,this.container),this.updateCardList()})).catch((e=>{MessageModal.alert(e,(()=>{document.location.href=root}))}))},getCards:async function(){try{const e=await Brainstorm.getCards();if(e.success)return e.rows.forEach((e=>{e.type=e.type.trim(),e.supertype=e.supertype.trim(),e.subtype=e.subtype.trim();let t=e.type;e.supertype&&(t=e.supertype+" "+t),e.subtype&&(t=t+" - "+e.subtype);let r=this.renderTextSymbols(e.description);e.flavor&&(r+=`<hr><i>${e.flavor}</i>`);let s=e.type.includes("Creature")?`${e.power}/${e.toughness}`:"",a=this.trimBraces(e.cost),i=0,o={blue:0,red:0,green:0,white:0,black:0,colorless:!1};[...a.matchAll(/\{(.*?)}/g)].map((e=>e[1])).forEach((e=>{e=e.toUpperCase(),isNaN(e)?(i+=1,e.includes("R")&&(o.red=2),e.includes("G")&&(o.green=8),e.includes("U")&&(o.blue=4),e.includes("W")&&(o.white=1),e.includes("B")&&(o.black=16)):(i+=parseInt(e),o.colorless=!0)}));const c=Object.entries(o).reduce(((e,[t,r])=>"colorless"===t?e:e|r),0);e.computed={name:e.name,legend:t,thumb_small:e.image?.webp_small?thumbnail_path+e.image.webp_small:null,thumb_medium:e.image?.webp_medium?thumbnail_path+e.image.webp_medium:null,thumb_large:e.image?.webp_large?thumbnail_path+e.image.webp_large:null,cost:a,cost_real:i,cost_render:this.renderSymbols(a),power_toughness:s,description:r,colorsum:c,colors:o}})),e.rows;throw e.errmsg}catch(e){return Promise.reject(e)}},setFilters:function(e={}){this.filters={...this.filters,...e};const[t,r]=this.filters.sortby.split("_");switch(t){case"added":this.cards.sort(((e,t)=>new Date(e.createdAt)-new Date(t.createdAt)));break;case"modified":this.cards.sort(((e,t)=>new Date(e.lastModifiedAt)-new Date(t.lastModifiedAt)));break;case"name":this.cards.sort(((e,t)=>e.name.localeCompare(t.name)));break;case"cost":this.cards.sort(((e,t)=>e.computed.cost_real===t.computed.cost_real?e.name.localeCompare(t.name):e.computed.cost_real-t.computed.cost_real));break;case"power":this.cards.sort(((e,t)=>e.power===t.power?e.name.localeCompare(t.name):e.power-t.power));break;case"toughness":this.cards.sort(((e,t)=>e.toughness===t.toughness?e.name.localeCompare(t.name):e.toughness-t.toughness))}"desc"==r&&this.cards.reverse(),this.filters.inclusive_sum=Object.entries({red:2,green:8,blue:4,white:1,black:16}).reduce(((e,[t,r])=>this.filters[t]?e|r:e),0),this.cards.forEach((e=>e.display=this.isCardDisplay(e)))},isCardDisplay:function(e){return(!this.filters.type||this.filters.type==e.type.toLowerCase())&&(this.filters.colorless?!e.computed.colorsum:!this.filters.inclusive_sum||!(!e.computed.colorsum&&this.filters.inclusive_sum)&&(e.computed.colorsum&this.filters.inclusive_sum)===e.computed.colorsum)},renderToolbar:function(){const e=create("div","card-toolbar"),t=e.create("div","card-toolbar__column"),r=t.create("select");this.data.sortby.forEach(((e,t)=>{const s=e.name+"_"+e.order;r.create("option","",e.title).value=s,this.filters.sortby==s&&(r.selectedIndex=t)})),r.addEventListener("change",(e=>{this.updateCardList({sortby:r.value})}));const s=t.create("select");s.create("option","","Tous les types").value="",this.data.types.forEach((e=>{s.create("option","",e.title).value=e.name})),s.addEventListener("change",(e=>{this.updateCardList({type:s.value})}));const a=e.create("div","card-toolbar__column");return["white","red","blue","green","black","colorless"].forEach((e=>{const t=a.create("input","checkbox-"+e);t.type="checkbox",t.addEventListener("change",(r=>{"colorless"==e&&a.querySelectorAll("input:not(.checkbox-colorless)").forEach((e=>{e.disabled=t.checked})),this.updateCardList({[e]:t.checked})}))})),e},renderCards:function(e){const t=create("div","card-grid");return e.forEach((e=>{e.display&&t.append(this.renderCard(e))})),t},renderCard:function(e){const t=create("div","card-grid__item"),r=t.create("div","card-grid__item__icon");e.computed.thumb_small&&(r.style.backgroundImage="url("+e.computed.thumb_small+")");const s=t.create("div","card-grid__item__details");s.create("div","card-grid__item__details__name",e.computed.name);const a=s.create("div","card-grid__item__details__description");return a.create("div","card-grid__item__details__description__legend",e.computed.legend),a.create("div","card-grid__item__details__description__power_toughness",e.computed.power_toughness),a.create("div","card-grid__item__details__description__cost",e.computed.cost_render),t.addEventListener("click",(t=>{this.modal.show(e.computed)})),t},updateCardList:async function(e={}){this.setFilters(e),this.container.replaceChildren(this.renderCards(this.cards))},renderSymbols:function(e){let t="";return[...String(e).matchAll(/\{(.*?)\}/g)].map((e=>e[1])).forEach((e=>{t+=`<div class="symbol-1em icon-${e.toUpperCase()}"></div>`})),t},renderTextSymbols:function(e){return String(e).replace(/\n/g,'<span class="line-break"></span>').replace(/\{i\}(.*?)\{\/i\}/gi,"<em>$1</em>").replace(/\{(?!\/?i\})(.*?)\}/gi,((e,t)=>`<div class="symbol-1em icon-${t.toUpperCase()}"></div>`))},trimBraces:function(e){return(String(e).match(/{[^}]*}/g)||[]).join("").toUpperCase()}};class CardModal extends Modal{constructor(){super(),this.cont.addEventListener("mousedown",(e=>this.hide())),document.addEventListener("keydown",(e=>{this.opened&&"Escape"===e.key&&!(e.ctrlKey||e.altKey||e.shiftKey)&&this.hide()}))}show(e){const t=create("div","cardinfo"),r=t.create("div","cardinfo__thumb");e.thumb_medium&&(r.style.backgroundImage="url("+e.thumb_medium+")"),t.create("div","cardinfo__name",e.name),t.create("div","cardinfo__legend",e.legend),t.create("div","cardinfo__cost","<strong>Co√ªt:</strong> "+e.cost_render),t.create("div","cardinfo__power_toughness","<strong>Force/Endurance:</strong> "+e.power_toughness),t.create("div","cardinfo__description",e.description),super.show(t)}}