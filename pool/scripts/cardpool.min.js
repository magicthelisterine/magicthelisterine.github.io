const thumbnail_path=root+"assets/images/cartes/thumbnails/",CardPool={data:null,main:null,modal:null,toolbar:null,cards:[],filters:{sortby:"added_desc",type:"",exclusive:!1,colorless:!1,blue:!1,green:!1,red:!1,black:!1,white:!1},init:async function(e){this.data=e,this.modal=new CardModal,this.main=query("main"),this.getCards().then((e=>{this.cards=e,this.setFilters(),this.container=create("article"),this.toolbar=this.renderToolbar(),this.container.append(this.renderCards(this.cards)),this.main.replaceChildren(this.toolbar,this.container)})).catch((e=>{MessageModal.alert(e,(()=>{document.location.href=root}))}))},getCards:async function(){try{const e=await Brainstorm.getCards();if(e.success)return e.rows.forEach((e=>{let t=e.type;e.supertype&&(t=e.supertype+" "+t),e.subtype&&(t=t+" - "+e.subtype);let r=this.renderTextSymbols(e.description);e.flavor&&(r+=`<hr><i>${e.flavor}</i>`);let s=null,a=null,i=null;e.image&&(e.image.webp_small&&(s=thumbnail_path+e.image.webp_small),e.image.webp_medium&&(a=thumbnail_path+e.image.webp_medium),e.image.webp_large&&(i=thumbnail_path+e.image.webp_large));let c=null;["Creature","Artifact Creature"].includes(e.type)&&(c=e.power+"/"+e.toughness);let o=this.trimBraces(e.cost),n=0,d={blue:!1,red:!1,green:!1,white:!1,black:!1,colorless:!1};[...o.matchAll(/\{(.*?)\}/g)].map((e=>e[1])).forEach((e=>{e=e.toUpperCase(),n+=isNaN(e)?1:parseInt(e),isNaN(e)?(e.includes("R")&&(d.red=!0),e.includes("G")&&(d.green=!0),e.includes("U")&&(d.blue=!0),e.includes("W")&&(d.white=!0),e.includes("B")&&(d.black=!0)):d.colorless=!0})),e.computed={name:e.name,legend:t,thumb_small:s,thumb_medium:a,thumb_large:i,cost:o,cost_real:n,cost_render:this.renderSymbols(o),power_toughness:c,description:r,colors:d}})),e.rows;throw e.errmsg}catch(e){return Promise.reject(e)}},setFilters:function(e={}){this.filters={...this.filters,...e};const[t,r]=this.filters.sortby.split("_");switch(t){case"added":this.cards.sort(((e,t)=>new Date(e.createdAt)-new Date(t.createdAt)));break;case"modified":this.cards.sort(((e,t)=>new Date(e.lastModifiedAt)-new Date(t.lastModifiedAt)));break;case"name":this.cards.sort(((e,t)=>e.name.localeCompare(t.name)));break;case"power":this.cards.sort(((e,t)=>e.power===t.power?e.name.localeCompare(t.name):e.power-t.power));break;case"toughness":this.cards.sort(((e,t)=>e.toughness===t.toughness?e.name.localeCompare(t.name):e.toughness-t.toughness))}"desc"==r&&this.cards.reverse(),this.cards.forEach((e=>e.display=this.isCardDisplay(e)))},isCardDisplay:function(e){return!this.filters.type||this.filters.type==e.type.toLowerCase()},renderToolbar:function(){const e=create("div","card-toolbar"),t=e.create("div","card-toolbar__column"),r=t.create("select");this.data.sortby.forEach(((e,t)=>{const s=e.name+"_"+e.order;r.create("option","",e.title).value=s,this.filters.sortby==s&&(r.selectedIndex=t)})),r.addEventListener("change",(e=>{this.sortBy(r.value)}));const s=t.create("select");s.create("option","","Tous les types").value="",this.data.types.forEach((e=>{s.create("option","",e.title).value=e.name})),s.addEventListener("change",(e=>{this.sortType(s.value)}));const a=e.create("div","card-toolbar__column");a.create("input","checkbox-white").type="checkbox";a.create("input","checkbox-red").type="checkbox";a.create("input","checkbox-blue").type="checkbox";a.create("input","checkbox-green").type="checkbox";a.create("input","checkbox-black").type="checkbox";a.create("input","checkbox-colorless").type="checkbox";return a.create("input","checkbox-exclusive").type="checkbox",e},renderCards:function(e){const t=create("div","card-grid");return e.forEach((e=>{e.display&&t.append(this.renderCard(e))})),t},renderCard:function(e){const t=create("div","card-grid__item"),r=t.create("div","card-grid__item__icon");e.computed.thumb_small&&(r.style.backgroundImage="url("+e.computed.thumb_small+")");const s=t.create("div","card-grid__item__details");s.create("div","card-grid__item__details__name",e.computed.name);const a=s.create("div","card-grid__item__details__description");return a.create("div","card-grid__item__details__description__legend",e.computed.legend),a.create("div","card-grid__item__details__description__power_toughness",e.computed.power_toughness),a.create("div","card-grid__item__details__description__cost",e.computed.cost_render),t.dataset.uuid=e.uuid,t.addEventListener("click",(t=>{this.modal.show(e.computed)})),t},updateCardList:function(){this.container.replaceChildren(this.renderCards(this.cards))},sortBy:function(e){this.setFilters({sortby:e}),this.updateCardList()},sortType:function(e){this.setFilters({type:e}),this.updateCardList()},renderSymbols:function(e){let t="";return[...String(e).matchAll(/\{(.*?)\}/g)].map((e=>e[1])).forEach((e=>{t+=`<div class="symbol-1em icon-${e}"></div>`})),t},renderTextSymbols:function(e){return String(e).replace(/\n/g,'<span class="line-break"></span>').replace(/\{i\}(.*?)\{\/i\}/gi,"<em>$1</em>").replace(/\{(?!\/?i\})(.*?)\}/gi,((e,t)=>`<div class="symbol-1em icon-${t.toUpperCase()}"></div>`))},trimBraces:function(e){return(String(e).match(/{[^}]*}/g)||[]).join("")}};class CardModal extends Modal{constructor(){super(),this.cont.addEventListener("mousedown",(e=>{this.hide()})),document.addEventListener("keydown",(e=>{this.opened&&"Escape"===e.key&&!(e.ctrlKey||e.altKey||e.shiftKey)&&this.hide()}))}show(e){const t=create("div","cardinfo"),r=t.create("div","cardinfo__thumb");if(e.thumb_medium){const t=new Image;t.addEventListener("load",(t=>{r.style.backgroundImage="url("+e.thumb_medium+")"})),t.src=e.thumb_medium}t.create("div","cardinfo__name",e.name),t.create("div","cardinfo__legend",e.legend),t.create("div","cardinfo__cost","<strong>Co√ªt:</strong> "+e.cost_render),t.create("div","cardinfo__power_toughness","<strong>Force/Endurance:</strong> "+(e.power_toughness?e.power_toughness:"")),t.create("div","cardinfo__description",e.description),super.show(t)}cancel(){this.hide()}}